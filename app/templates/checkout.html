{% extends "base.html" %}

{% block body_class %}checkout-page-body{% endblock %}

{% block content %}
<section class="checkout-page">
  <h1 class="page-title">Checkout</h1>
  <div class="checkout-layout">
  <div class="checkout-cart">
    <h2 class="checkout-subtitle">Your order</h2>
    <ul class="cart-items">
      {% for item in items %}
      <li class="cart-item">
        <span class="cart-item-name">{{ item.name }}</span>
        <span class="cart-item-qty">× {{ item.quantity }}</span>
        <span class="cart-item-price">{{ "%.2f"|format(item.price_cents * item.quantity / 100) }} {{ currency }}</span>
      </li>
      {% endfor %}
    </ul>
    <p class="cart-total">
      <strong>Total:</strong>
      <span class="cart-total-amount">{{ "%.2f"|format(total_cents / 100) }} {{ currency }}</span>
    </p>
  </div>

  <div class="checkout-payment">
    <h2 class="checkout-subtitle">Payment</h2>
    <div id="test-response-wrap" class="test-response-wrap" style="display: none;">
      <label for="test-acquirer-response" class="test-response-label">Simulate outcome (test only)</label>
      <select id="test-acquirer-response" class="test-response-select" aria-label="RequestedTestAcquirerResponseCode">
        <option value="">Default (no override)</option>
        <option value="0">0 – Error (Unknown)</option>
        <option value="1">1 – Authorised</option>
        <option value="2">2 – Refused</option>
        <option value="3">3 – Refused (Referral)</option>
        <option value="4">4 – Error (Acquirer Error)</option>
        <option value="5">5 – Refused (Blocked Card)</option>
        <option value="6">6 – Refused (Expired Card)</option>
        <option value="7">7 – Refused (Invalid Amount)</option>
        <option value="8">8 – Refused (Invalid Card Number)</option>
        <option value="9">9 – Refused (Issuer Unavailable)</option>
        <option value="10">10 – Refused (Not supported)</option>
        <option value="11">11 – Refused (3D Not Authenticated)</option>
        <option value="12">12 – Refused (Not enough balance)</option>
        <option value="13">13 – Received (Pending)</option>
        <option value="14">14 – Refused (Acquirer Fraud)</option>
        <option value="15">15 – Refused (Cancelled)</option>
        <option value="16">16 – Refused (Shopper Cancelled)</option>
        <option value="22">22 – Cancelled (FRAUD-CANCELLED)</option>
      </select>
    </div>
    <div id="adyen-dropin-container"></div>
    <div id="adyen-dropin-error" class="adyen-error" role="alert" hidden></div>
  </div>
  </div>
</section>

<script>
// Run before Adyen SDK: make touchstart/touchmove passive by default to avoid scroll-blocking warning
(function () {
  var supportsPassive = false;
  try {
    var opts = Object.defineProperty({}, 'passive', { get: function () { supportsPassive = true; } });
    window.addEventListener('test', null, opts);
  } catch (e) {}
  if (!supportsPassive) return;
  var _addEventListener = EventTarget.prototype.addEventListener;
  EventTarget.prototype.addEventListener = function (type, fn, capture) {
    var cap = capture;
    if (type === 'touchstart' || type === 'touchmove') {
      if (typeof capture !== 'object' || capture === null) cap = { passive: true, capture: !!capture };
      else if (capture.passive === undefined) cap = Object.assign({}, capture, { passive: true });
    }
    return _addEventListener.call(this, type, fn, cap);
  };
})();
</script>
<script src="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/6.16.0/adyen.js"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/6.16.0/adyen.css" />
{% endblock %}

{% block scripts %}
<script>
(function () {
  var clientKey = {{ client_key | tojson }};
  var environment = {{ environment | tojson }};
  var totalCents = {{ total_cents }};
  var currency = {{ currency | tojson }};
  var baseUrl = {{ request.url_root | tojson }};

  if (!clientKey) {
    document.getElementById('adyen-dropin-error').textContent = 'Adyen client key not configured. Set ADYEN_CLIENT_KEY in .env.';
    document.getElementById('adyen-dropin-error').hidden = false;
    return;
  }

  function getBrowserInfo() {
    return {
      acceptHeader: navigator.acceptHeader || window.navigator.language,
      colorDepth: window.screen.colorDepth,
      javaEnabled: typeof navigator.javaEnabled === 'function' ? navigator.javaEnabled() : false,
      language: navigator.language,
      screenHeight: window.screen.height,
      screenWidth: window.screen.width,
      timeZoneOffset: -new Date().getTimezoneOffset(),
      userAgent: navigator.userAgent
    };
  }

  function fetchPaymentMethods() {
    return fetch(baseUrl + 'api/adyen/paymentMethods', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        amount: { value: totalCents, currency: currency },
        countryCode: 'NL',
        channel: 'Web',
        browserInfo: getBrowserInfo()
      })
    }).then(function (r) { return r.json(); });
  }

  function getReturnUrl() {
    return baseUrl.replace(/\/$/, '') + '/checkout/return';
  }

  // Result codes: https://docs.adyen.com/online-payments/build-your-integration/payment-result-codes
  var SUCCESS_RESULT_CODES = ['Authorised', 'Pending', 'Received', 'PartiallyAuthorised'];
  var FAILURE_RESULT_CODES = ['Refused', 'Cancelled', 'Error'];

  function redirectFromPaymentResponse(response) {
    if (!response || response.action) return; // Drop-in will handle action (redirect/3DS)
    var code = response.resultCode;
    if (!code) return;
    var successUrl = baseUrl.replace(/\/$/, '') + '/checkout/success';
    var failedUrl = baseUrl.replace(/\/$/, '') + '/checkout/failed';
    if (SUCCESS_RESULT_CODES.indexOf(code) !== -1) {
      window.location.href = successUrl;
      return;
    }
    if (FAILURE_RESULT_CODES.indexOf(code) !== -1) {
      window.location.href = failedUrl;
      return;
    }
    // Intermediate (e.g. PresentToShopper, ChallengeShopper) are handled by action; if no action, treat as pending/success
    if (code === 'PresentToShopper' || code === 'ChallengeShopper' || code === 'IdentifyShopper' || code === 'RedirectShopper') return;
    if (code === 'AuthenticationNotRequired' || code === 'AuthenticationFinished') return;
    // Any other code: redirect to success to be safe (e.g. legacy codes)
    window.location.href = successUrl;
  }

  fetchPaymentMethods().then(function (paymentMethodsResponse) {
    if (paymentMethodsResponse.error || paymentMethodsResponse.message) {
      var el = document.getElementById('adyen-dropin-error');
      el.textContent = paymentMethodsResponse.error || paymentMethodsResponse.message || 'Failed to load payment methods';
      el.hidden = false;
      return;
    }

    var testResponseEl = document.getElementById('test-response-wrap');
    var testAcquirerSelect = document.getElementById('test-acquirer-response');
    if (environment === 'test' && testResponseEl) testResponseEl.style.display = 'block';

    var dropinInstance = null;
    var cardConfig = {
      hasHolderName: true,
      holderNameRequired: true,
      billingAddressRequired: true
    };
    var dropinConfiguration = {
      paymentMethodsConfiguration: {
        card: cardConfig
      }
    };
    var configuration = {
      clientKey: clientKey,
      environment: environment,
      locale: 'en-US',
      countryCode: 'NL',
      paymentMethodsResponse: paymentMethodsResponse,
      paymentMethodsConfiguration: { card: cardConfig },
      onSubmit: function (state, component) {
        var payload = state.data;
        payload.amount = { value: totalCents, currency: currency };
        payload.reference = 'ref-' + Date.now();
        payload.browserInfo = getBrowserInfo();
        payload.channel = 'Web';
        payload.returnUrl = getReturnUrl();
        // Required for 3DS2 (redirect and native): origin where Drop-in is rendered (no path/trailing slash)
        if (typeof window.location.origin !== 'undefined') payload.origin = window.location.origin;
        payload.additionalData = payload.additionalData || {};
        // Prefer native 3DS2 (in-page challenge) when supported; otherwise redirect 3DS is used
        if (!payload.authenticationData) payload.authenticationData = {};
        if (!payload.authenticationData.threeDSRequestData) payload.authenticationData.threeDSRequestData = {};
        payload.authenticationData.threeDSRequestData.nativeThreeDS = 'preferred';
        // Cardholder name is collected by Drop-in (hasHolderName/holderNameRequired) and sent in payload.paymentMethod.holderName
        var testCode = testAcquirerSelect ? testAcquirerSelect.value : '';
        if (testCode) {
          payload.additionalData.RequestedTestAcquirerResponseCode = parseInt(testCode, 10);
        }

        return fetch(baseUrl + 'api/adyen/payments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(function (r) { return r.json(); }).then(function (response) {
          if (response.action && response.action.type === 'redirect') {
            try {
              if (response.action.paymentData) {
                sessionStorage.setItem('adyenPaymentData', response.action.paymentData);
              }
            } catch (e) {}
          }
          // Let Drop-in handle 3DS2 action: redirect (action.url) or native (threeDS2 challenge in-page)
          if (response.action && dropinInstance && typeof dropinInstance.handleAction === 'function') {
            var handleResult = dropinInstance.handleAction(response.action);
            if (handleResult && typeof handleResult.then === 'function') {
              return handleResult.then(function () { return response; });
            }
            return response;
          }
          redirectFromPaymentResponse(response);
          return response;
        });
      },
      onAdditionalDetails: function (state, component) {
        return fetch(baseUrl + 'api/adyen/payments/details', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(state.data)
        }).then(function (r) { return r.json(); }).then(function (response) {
          redirectFromPaymentResponse(response);
          return response;
        });
      }
    };

    // Adyen Web v6 CDN: window.AdyenWeb is UMD export object; .default is AdyenCheckout (async create function)
    var adyenExport = window.AdyenWeb || window.AdyenCheckout || (window.adyen && window.adyen.AdyenCheckout);
    var AdyenCheckoutFn = typeof adyenExport === 'function' ? adyenExport : (adyenExport && (adyenExport.default || adyenExport.AdyenCheckout));
    var DropinClass = adyenExport && (adyenExport.Dropin || (adyenExport.components && adyenExport.components.Dropin));
    if (typeof AdyenCheckoutFn !== 'function') {
      document.getElementById('adyen-dropin-error').textContent = 'Adyen Checkout script did not load.';
      document.getElementById('adyen-dropin-error').hidden = false;
      return;
    }
    var container = document.getElementById('adyen-dropin-container');
    AdyenCheckoutFn(configuration).then(function (checkout) {
      if (typeof checkout.create === 'function') {
        dropinInstance = checkout.create('dropin', dropinConfiguration);
      } else if (DropinClass && typeof DropinClass === 'function') {
        dropinInstance = new DropinClass(checkout, dropinConfiguration);
      } else if (checkout.getComponent && checkout.getComponent('dropin')) {
        var D = checkout.getComponent('dropin');
        dropinInstance = new D(checkout, dropinConfiguration);
      }
      if (dropinInstance && typeof dropinInstance.mount === 'function') {
        dropinInstance.mount(container);
      } else {
        var el = document.getElementById('adyen-dropin-error');
        el.textContent = 'Adyen Drop-in could not be created. This bundle may not include Drop-in.';
        el.hidden = false;
      }
    }).catch(function (err) {
      var el = document.getElementById('adyen-dropin-error');
      el.textContent = err.message || 'Failed to create Drop-in';
      el.hidden = false;
    });
  }).catch(function (err) {
    var el = document.getElementById('adyen-dropin-error');
    el.textContent = err.message || 'Failed to load payment methods';
    el.hidden = false;
  });
})();
</script>
{% endblock %}
